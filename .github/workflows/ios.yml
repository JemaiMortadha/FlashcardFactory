name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install xcodegen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
    
    - name: Restore GoogleService-Info.plist from GitHub Secret
      env:
        GOOGLE_SERVICE_INFO: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
      run: |
        echo "$GOOGLE_SERVICE_INFO" | base64 --decode > FlashcardFactory/GoogleService-Info.plist
      
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: Pods
        key: ${{ runner.os }}-pods-v1
        restore-keys: |
          ${{ runner.os }}-pods-
    
    - name: Install CocoaPods dependencies
      run: pod install
    
    - name: Build iOS App for Simulator
      run: |
        xcodebuild -workspace FlashcardFactory.xcworkspace \
          -scheme FlashcardFactory \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          clean build
    
    - name: Find and Prepare .app Bundle
      if: success()
      run: |
        echo "ðŸ” Searching for .app bundle..."
        
        # Find the built app
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "FlashcardFactory.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "Searching in workspace..."
          APP_PATH=$(find . -name "FlashcardFactory.app" -type d | head -n 1)
        fi
        
        echo "ðŸ“± Found app at: $APP_PATH"
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ Error: .app bundle not found"
          echo "Searching everywhere..."
          find ~ -name "FlashcardFactory.app" -type d 2>/dev/null | head -5
          exit 1
        fi
        
        # Copy Info.plist into the bundle if missing
        if [ ! -f "$APP_PATH/Info.plist" ]; then
          echo "âš ï¸ Info.plist missing, copying from source..."
          cp FlashcardFactory/Info.plist "$APP_PATH/"
          echo "âœ… Info.plist copied"
        else
          echo "âœ… Info.plist already exists"
        fi
        
        # Verify contents
        echo "ðŸ“‹ App bundle contents:"
        ls -la "$APP_PATH" | head -20
        
        echo "ðŸ“¦ Creating archive for Appetize.io..."
        ARCHIVE_DIR=$(pwd)
        cd "$(dirname "$APP_PATH")"
        tar -czf "$ARCHIVE_DIR/FlashcardFactory.app.tar.gz" "$(basename "$APP_PATH")"
        
        echo "âœ… Archive created: $ARCHIVE_DIR/FlashcardFactory.app.tar.gz"
        echo "APP_ARCHIVE_PATH=$ARCHIVE_DIR/FlashcardFactory.app.tar.gz" >> $GITHUB_ENV
    
    - name: Upload .app Bundle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: FlashcardFactory-iOS-App
        path: ${{ env.APP_ARCHIVE_PATH }}
        retention-days: 7
