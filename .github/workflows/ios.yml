name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install xcodegen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
    
    - name: Restore GoogleService-Info.plist from GitHub Secret
      env:
        GOOGLE_SERVICE_INFO: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
      run: |
        echo "$GOOGLE_SERVICE_INFO" | base64 --decode > FlashcardFactory/GoogleService-Info.plist
      
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: Pods
        key: ${{ runner.os }}-pods-v1
        restore-keys: |
          ${{ runner.os }}-pods-
    
    - name: Install CocoaPods dependencies
      run: pod install
    
    - name: Build iOS App for Device
      run: |
        xcodebuild -workspace FlashcardFactory.xcworkspace \
          -scheme FlashcardFactory \
          -destination 'generic/platform=iOS' \
          -configuration Debug \
          -sdk iphoneos \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          -verbose \
          clean build 2>&1 | tee build.log
        
    - name: Upload Build Log on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
    
    - name: Find and Archive .app Bundle
      if: success()
      run: |
        echo "ðŸ” Searching for .app bundle..."
        echo "Current directory: $(pwd)"
        echo "Workspace: $GITHUB_WORKSPACE"
        
        # Search in current workspace build directories
        echo "Searching in workspace..."
        find . -name "*.app" -type d
        
        APP_PATH=$(find . -name "FlashcardFactory.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "Searching in common build locations..."
          APP_PATH=$(find build -name "FlashcardFactory.app" -type d 2>/dev/null | head -n 1)
        fi
        
        if [ -z "$APP_PATH" ]; then
          echo "Searching in DerivedData..."
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "FlashcardFactory.app" -type d 2>/dev/null | head -n 1)
        fi
        
        echo "ðŸ“± Found app at: $APP_PATH"
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ Error: .app bundle not found"
          echo "Build directory structure:"
          ls -R build/ 2>/dev/null || echo "No build/ directory"
          ls -R . | grep -i "\.app" || echo "No .app found"
          exit 1
        fi
        
        # Verify Info.plist exists
        if [ ! -f "$APP_PATH/Info.plist" ]; then
          echo "âš ï¸ Warning: Info.plist not found in .app bundle"
          echo "Contents of .app:"
          ls -la "$APP_PATH"
        else
          echo "âœ… Info.plist found!"
        fi
        
        echo "ðŸ“¦ Creating archive..."
        ARCHIVE_DIR=$(pwd)
        cd "$(dirname "$APP_PATH")"
        zip -r "$ARCHIVE_DIR/FlashcardFactory.app.zip" "$(basename "$APP_PATH")"
        
        echo "âœ… Archive created: $ARCHIVE_DIR/FlashcardFactory.app.zip"
        echo "APP_ARCHIVE_PATH=$ARCHIVE_DIR/FlashcardFactory.app.zip" >> $GITHUB_ENV
    
    - name: Upload .app Bundle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: FlashcardFactory-iOS-App
        path: ${{ env.APP_ARCHIVE_PATH }}
        retention-days: 7
    
    - name: Run Tests (Optional)
      run: |
        xcodebuild test \
          -workspace FlashcardFactory.xcworkspace \
          -scheme FlashcardFactory \
          -destination 'generic/platform=iOS Simulator' \
          CODE_SIGNING_ALLOWED=NO
      continue-on-error: true
