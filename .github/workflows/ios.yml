name: iOS Build (Fast)

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Quick iOS Build
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install xcodegen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
    
    - name: Restore Firebase Config
      env:
        GOOGLE_SERVICE_INFO: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
      run: |
        echo "$GOOGLE_SERVICE_INFO" | base64 --decode > FlashcardFactory/GoogleService-Info.plist
    
    - name: Install Pods (with retry)
      run: |
        for i in 1 2 3; do
          pod install && break || sleep 5
        done
    
    - name: Build
      run: |
        set -o pipefail
        xcodebuild \
          -workspace FlashcardFactory.xcworkspace \
          -scheme FlashcardFactory \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          clean build | xcpretty || xcodebuild \
          -workspace FlashcardFactory.xcworkspace \
          -scheme FlashcardFactory \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          clean build
    
    - name: Package App
      if: success()
      run: |
        APP=$(find ~/Library/Developer/Xcode/DerivedData -name "FlashcardFactory.app" | head -1)
        if [ -n "$APP" ]; then
          cp FlashcardFactory/Info.plist "$APP/" 2>/dev/null || true
          cd "$(dirname "$APP")"
          tar czf ~/FlashcardFactory.app.tar.gz "$(basename "$APP")"
          echo "âœ… App packaged"
        fi
    
    - name: Upload App
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: FlashcardFactory-App
        path: ~/FlashcardFactory.app.tar.gz
        if-no-files-found: warn
